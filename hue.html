<!doctype html>
<html lang=en>

<head>
    <meta charset=utf-8>
    <title>Philips Hue BLE</title>

    <script>
        // https://developer.chrome.com/articles/bluetooth/
        class PhilipsHueClient {
            SERVICE_UUID() { return '0000fe0f-0000-1000-8000-00805f9b34fb' }
            _command(code) {
                return '932c32bd-' + String(code).padStart(4, '0') + '-47a2-835a-a8d455b859dd'
            }
            async request() {
                navigator.bluetooth.requestDevice({
                    filters: [{
                        services: [this.SERVICE_UUID()]
                    }],
                    optionalServices: [this._command(0)]
                })
                .then(device => { 
                    console.log(device) 
                    return device.gatt.connect();
                })
                .then(server => {
                    return server.getPrimaryService(this._command(0));
                })
                .then(service => {
                    this.service = service;
                })
                .catch(error => { 
                    console.error(error); 
                });
            }
            async get_power() {
                return await this.service.getCharacteristic(this._command(2))
                .then(gatt_char => {
                    return gatt_char.readValue();
                })
                .then(resp => {
                    return Boolean(resp.getUint8(0));
                })
            }
            async set_power(enabled) {
                await this.service.getCharacteristic(this._command(2))
                .then(gatt_char => {
                    let data = Uint8Array.of(Number(enabled));
                    return gatt_char.writeValue(data);
                })
            }
            async get_brightness() {
                return await this.service.getCharacteristic(this._command(3))
                .then(gatt_char => {
                    return gatt_char.readValue();
                })
                .then(resp => {
                    return resp.getUint8(0) / 254;
                })
            }
            async set_brightness(ratio) {
                await this.service.getCharacteristic(this._command(3))
                .then(gatt_char => {
                    let data = Uint8Array.of(Math.max(1, Math.min(Number(Math.round(ratio * 254)), 254)));
                    return gatt_char.writeValue(data);
                })
            }
            async get_temperature_k() {
                return await this.service.getCharacteristic(this._command(4))
                .then(gatt_char => {
                    return gatt_char.readValue();
                })
                .then(resp => {
                    let colortemp_mireds = resp.getInt16(0, true)
                    if (colortemp_mireds == -1) {
                        return -1
                    } else {
                        console.warn(colortemp_mireds)
                        return Number(Math.round(1e6 / colortemp_mireds))
                    }
                })
            }
            async set_temperature_k(temperature_k) {
                await this.service.getCharacteristic(this._command(4))
                .then(gatt_char => {
                    let colortemp_mireds = Number(Math.round(1e6 / temperature_k))
                    let data = Int16Array.of(Math.max(153, Math.min(colortemp_mireds, 500)))
                    return gatt_char.writeValue(data);
                })
            }
            async get_xy() {
                return await this.service.getCharacteristic(this._command(5))
                .then(gatt_char => {
                    return gatt_char.readValue();
                })
                .then(resp => {
                    const scale = 1 / Math.pow(2, 16)
                    let x = resp.getUint16(0, true) * scale
                    let y = resp.getUint16(2, true) * scale
                    return { x: x, y: y }
                })
            }
            async set_xy(x, y) {
                await this.service.getCharacteristic(this._command(5))
                .then(gatt_char => {
                    const scale = Math.pow(2, 16)
                    let data = Uint16Array.of(x * scale, y * scale)
                    return gatt_char.writeValue(data);
                })
            }
        }

        // https://codeandlife.com/2022/03/20/control-philips-hue-color-rgb-lights-with-python/
        function rgb2xyb(r, g, b) {
            if (r > 0.04045) { r = ((r + 0.055) / 1.055)**2.4 } else { r = r / 12.92 }
            if (g > 0.04045) { g = ((g + 0.055) / 1.055)**2.4 } else { g = g / 12.92 }
            if (b > 0.04045) { b = ((b + 0.055) / 1.055)**2.4 } else { b = b / 12.92 }
            let X = r * 0.4124 + g * 0.3576 + b * 0.1805
            let Y = r * 0.2126 + g * 0.7152 + b * 0.0722
            let Z = r * 0.0193 + g * 0.1192 + b * 0.9505
            return {x: X / (X + Y + Z), y: Y / (X + Y + Z), b: Y}
        }
    </script>
</head>

<body>
    <p><button id="pair_button">Pair</button></p>
    <p><button id="toggle_button">Toggle</button></p>
    <p><button id="random_button">Random Color</button></p>
    <p>Brightness: <input id="brightness_slider" type="range" min="0" max="1" step="0.001"></p>
    <p>Color Temperature: <input id="tmep_k_slider" type="range" min="2000" max="6500" step="100"></p>
    <script>
        let hue = new PhilipsHueClient()

        let pair_button = document.getElementById('pair_button')
        pair_button.addEventListener('click', async function (e) {
            await hue.request()
        });

        let toggle_button = document.getElementById('toggle_button')
        async function toggle_handler(e) {
            let light_on = await hue.get_power()
            console.log(light_on)
            hue.set_power(!light_on)
        }
        toggle_button.addEventListener('click', toggle_handler);

        let random_button = document.getElementById('random_button')
        async function random_handler(e) {
            let xyb = rgb2xyb(Math.random(), Math.random(), Math.random())
            await hue.set_xy(xyb.x, xyb.y)
            console.log(await hue.get_xy())
            await hue.set_brightness(xyb.b)
            console.log(await hue.get_brightness())
        }
        random_button.addEventListener('click', random_handler);

        let brightness_slider = document.getElementById('brightness_slider')
        async function brightness_handler(e) {
            console.log(this.value)
            await hue.set_brightness(this.value)
            console.log(await hue.get_brightness())
        }
        brightness_slider.addEventListener('input', brightness_handler);
        brightness_slider.addEventListener('change', brightness_handler);

        let tmep_k_slider = document.getElementById('tmep_k_slider')
        async function tmep_k_handler(e) {
            console.log(this.value)
            await hue.set_temperature_k(this.value)
            console.log(await hue.get_temperature_k())
        }
        tmep_k_slider.addEventListener('input', tmep_k_handler);
        tmep_k_slider.addEventListener('change', tmep_k_handler);
    </script>
</body>

</html>